name: SpaceSim Agents

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1-5"

jobs:
  agent:
    name: Run ${{ matrix.agent }} agent
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - agent: renderer
            path: engine/renderer
            prompt: prompts/renderer.md
          - agent: sim
            path: engine/sim
            prompt: prompts/sim.md
          - agent: ui
            path: engine/ui
            prompt: prompts/ui.md

    permissions:
      contents: write
      pull-requests: write

    env:
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      MODEL_ID: "opencode:Grok Code Fast 1"

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup dependencies with Nix
        run: |
          echo "Nix environment will be used for builds"

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          export PATH="$HOME/.opencode/bin:$PATH"
          opencode --version

      - name: Configure provider (if keys present)
        run: |
          echo "Configuring opencode provider..."
          # Try to configure opencode provider first (no API key needed)
          if opencode providers add opencode; then
            echo "‚úÖ Using OpenCode provider"
          elif [ -n "${XAI_API_KEY}" ]; then
            opencode providers add xai --api-key "${XAI_API_KEY}"
            echo "‚úÖ Using xAI provider"
          elif [ -n "${OPENROUTER_API_KEY}" ]; then
            opencode providers add openrouter --api-key "${OPENROUTER_API_KEY}"
            echo "‚úÖ Using OpenRouter provider"
          else
            echo "‚ö†Ô∏è No API key present; attempting any public access available."
          fi
          echo "Available providers:"
          opencode providers list || echo "Failed to list providers"

      - name: Pick model safely
        run: |
          if [ -z "${MODEL_ID}" ]; then
            # Try opencode provider first (no API key needed)
            if opencode providers list 2>/dev/null | grep -q opencode; then
              echo 'MODEL_ID=opencode:Grok Code Fast 1' >> $GITHUB_ENV
              echo "üéØ Selected model: opencode:Grok Code Fast 1"
            elif [ -n "${XAI_API_KEY}" ]; then
              echo "MODEL_ID=xai:grok-code-fast-1" >> $GITHUB_ENV
              echo "üéØ Selected model: xai:grok-code-fast-1"
            elif [ -n "${OPENROUTER_API_KEY}" ]; then
              echo "MODEL_ID=openrouter:xai/grok-code-fast" >> $GITHUB_ENV
              echo "üéØ Selected model: openrouter:xai/grok-code-fast"
            else
              # Fallback (small, cheaper) so the run still produces PRs
              echo "MODEL_ID=openrouter:anthropic/claude-3.5-sonnet" >> $GITHUB_ENV
              echo "üéØ Selected fallback model: openrouter:anthropic/claude-3.5-sonnet"
            fi
          else
            echo "üéØ Using pre-configured model: ${MODEL_ID}"
          fi

      - name: New branch for agent
        run: |
          git config user.name "bot-${{ matrix.agent }}"
          git config user.email "bot+${{ matrix.agent }}@users.noreply.github.com"
          git checkout -b "agent/${{ matrix.agent }}-${{ github.run_id }}"

       - name: Run ${{ matrix.agent }} with path scope
         run: |
           printf "\n\n### FILE SCOPE ###\nOnly modify: ${{ matrix.path }}/, contracts/ (read-only unless instructed), assets/ for renderer.\n" >> ${{ matrix.prompt }}
           echo "üîß Running ${{ matrix.agent }} agent with model: ${MODEL_ID}"
           echo "üìÅ Working directory: $(pwd)"
           echo "üìÑ Prompt file: ${{ matrix.prompt }}"
           opencode run \
             --model "${MODEL_ID}" \
             --working-dir "." \
             --allow-path "${{ matrix.path }}" \
             --allow-path "contracts" \
             --allow-path "assets" \
             --prompt-file "${{ matrix.prompt }}" \
             "Improve the ${{ matrix.agent }} module with better functionality, error handling, and performance optimizations. Focus on the file scope restrictions and maintain compatibility with existing contracts."

      - name: Build & test (strict)
        run: |
          nix develop --command bash -c "
            cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
            cmake --build build --target all
            ctest --test-dir build --output-on-failure
          "

      - name: Commit changes
        run: |
          if ! git diff --quiet; then
            git add -A
            git commit -m "agent(${{ matrix.agent }}): automated updates"
          else
            echo "No changes from agent."
          fi

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: "agent/${{ matrix.agent }}-${{ github.run_id }}"
          title: "Agent: ${{ matrix.agent }} updates"
          body: |
            Automated changes from `${{ matrix.agent }}` agent.
            - Prompt: `${{ matrix.prompt }}`
            - Path scope: `${{ matrix.path }}`
            - Model: `${{ env.MODEL_ID }}`
          labels: |
            agent
            ${{ matrix.agent }}